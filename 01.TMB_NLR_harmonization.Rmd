##############################################################################################
Aim: TMB and dNLR value harmonization 

To harmonize TMB values in Ravi, Pradat and Shim et al. cohorts to MSK TMB values using normal transformation (power transformations) followed by standardization to Z-scores.
To harmonize dNLR in vanguri et al. cohorts to MSK NLR values using normal transformation (power transformations) followed by standardization to Z-scores.
##############################################################################################

# load required package
```{r}
library(rcompanion)
library(readxl)

```

# Set parameters and directories
```{r}
input_dir = "../02.Input/"
result_dir = "../03.Results/"

```


# load data 
```{r}
selected_cols = c('CancerType','TMB_original')
Chowell1_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Chowell2015-2017")
Chowell1_info_df = Chowell1_info_df[selected_cols]
Chowell2_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Chowell2018")
Chowell2_info_df = Chowell2_info_df[selected_cols]
MSK1_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Morris_new")
MSK1_info_df = MSK1_info_df[selected_cols]
MSK_info_df = rbind(Chowell1_info_df,Chowell2_info_df,MSK1_info_df)
MSK_info_df = MSK_info_df[MSK_info_df$CancerType=='NSCLC',]
#MSK_info_df$TMB <- ifelse(MSK_info_df$TMB > 50, 50, MSK_info_df$TMB)

Lee_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Lee_NSCLC")
Lee_info_df = Lee_info_df[selected_cols]
#Lee_info_df$TMB <- ifelse(Lee_info_df$TMB > 1500, 1500, Lee_info_df$TMB)

colnames(MSK_info_df)=c('CancerType','TMB')
colnames(Lee_info_df)=c('CancerType','TMB')


```


# TMB harmonization (Lee, Ravi, Pradat)
```{r}

selected_cols = c('CancerType','TMB_original')
Chowell1_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Chowell2015-2017")
Chowell1_info_df = Chowell1_info_df[selected_cols]
Chowell2_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Chowell2018")
Chowell2_info_df = Chowell2_info_df[selected_cols]
MSK1_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Morris_new")
MSK1_info_df = MSK1_info_df[selected_cols]
MSK2_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Morris_new2")
MSK2_info_df = MSK2_info_df[selected_cols]
MSK_info_df = rbind(Chowell1_info_df,Chowell2_info_df,MSK1_info_df,MSK2_info_df)
colnames(MSK_info_df)=c('CancerType','TMB')

MSK_NSCLC_info_df = MSK_info_df[MSK_info_df$CancerType=='NSCLC',]


Lee_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Lee_NSCLC")
Lee_info_df = Lee_info_df[selected_cols]
Ravi_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Ravi_NSCLC")
Ravi_info_df = Ravi_info_df[selected_cols]

Pradat_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Pradat_panCancer")
Pradat_info_df = Pradat_info_df[selected_cols]
colnames(Pradat_info_df)=c('CancerType','TMB_original')


# identify the optimal transformation coefficient for normal transformation (power transformations)
# MSK_NSCLC
# get the normalized TMB for validation of transformation coefficient extraction
transformed_TMB = transformTukey(MSK_NSCLC_info_df$TMB, plotit=FALSE)
scaled_TMB_MSK <- scale(transformed_TMB)
# extract transformation coefficients
lambda_MSK = transformTukey(MSK_NSCLC_info_df$TMB, plotit=TRUE, returnLambda = TRUE)
print(paste('Lambda_MSK_NSCLC: ', lambda_MSK))
mean_TMB_MSK <- attr(scaled_TMB_MSK, "scaled:center")
std_TMB_MSK <- attr(scaled_TMB_MSK, "scaled:scale")


#######  Lee_NSCLC 
# extract transformation coefficients
transformed_TMB = transformTukey(Lee_info_df$TMB_original, plotit=FALSE)
scaled_TMB_Lee <- scale(transformed_TMB)
lambda_Lee = transformTukey(Lee_info_df$TMB_original, plotit=TRUE, returnLambda = TRUE)
print(paste('Lambda_Lee: ', lambda_Lee))
scaled_TMB_Lee <- scale(transformed_TMB)
mean_TMB_Lee <- attr(scaled_TMB_Lee, "scaled:center")
std_TMB_Lee <- attr(scaled_TMB_Lee, "scaled:scale")
scaled_TMB2_Lee = (Lee_info_df$TMB_original ^ lambda_Lee - mean_TMB_Lee) / std_TMB_Lee
temp_TMB = scaled_TMB2_Lee*std_TMB_MSK + mean_TMB_MSK
temp_TMB <- ifelse(temp_TMB < 0, 0, temp_TMB)
harmonized_TMB_Lee = (temp_TMB)^(1/lambda_MSK)
Lee_info_df['TMB_harmonized'] = harmonized_TMB_Lee
write.csv(Lee_info_df, paste0(result_dir,"Lee_TMB_harmonized.csv"))

#######  Ravi_NSCLC 
# extract transformation coefficients
transformed_TMB = transformTukey(Ravi_info_df$TMB_original, plotit=FALSE)
scaled_TMB_Ravi <- scale(transformed_TMB)
lambda_Ravi = transformTukey(Ravi_info_df$TMB_original, plotit=TRUE, returnLambda = TRUE)
print(paste('Lambda_Ravi: ', lambda_Ravi))
scaled_TMB_Ravi <- scale(transformed_TMB)
mean_TMB_Ravi <- attr(scaled_TMB_Ravi, "scaled:center")
std_TMB_Ravi <- attr(scaled_TMB_Ravi, "scaled:scale")
scaled_TMB2_Ravi = (Ravi_info_df$TMB_original ^ lambda_Ravi - mean_TMB_Ravi) / std_TMB_Ravi
temp_TMB = scaled_TMB2_Ravi*std_TMB_MSK + mean_TMB_MSK
temp_TMB <- ifelse(temp_TMB < 0, 0, temp_TMB)
harmonized_TMB_Ravi = (temp_TMB)^(1/lambda_MSK)
Ravi_info_df['TMB_harmonized'] = harmonized_TMB_Ravi
write.csv(Ravi_info_df, paste0(result_dir,"Ravi_TMB_harmonized.csv"))


# identify the optimal transformation coefficient for normal transformation (power transformations)
# MSK
# get the normalized TMB for validation of transformation coefficient extraction
transformed_TMB = transformTukey(MSK_info_df$TMB, plotit=FALSE)
scaled_TMB_MSK <- scale(transformed_TMB)
# extract transformation coefficients
lambda_MSK = transformTukey(MSK_info_df$TMB, plotit=TRUE, returnLambda = TRUE)
print(paste('Lambda_MSK: ', lambda_MSK))
mean_TMB_MSK <- attr(scaled_TMB_MSK, "scaled:center")
std_TMB_MSK <- attr(scaled_TMB_MSK, "scaled:scale")

#######  Pradat
# extract transformation coefficients
transformed_TMB = transformTukey(Pradat_info_df$TMB_original, plotit=FALSE)
scaled_TMB_Pradat <- scale(transformed_TMB)
lambda_Pradat = transformTukey(Pradat_info_df$TMB_original, plotit=TRUE, returnLambda = TRUE)
print(paste('Lambda_Pradat: ', lambda_Pradat))
scaled_TMB_Pradat <- scale(transformed_TMB)
mean_TMB_Pradat <- attr(scaled_TMB_Pradat, "scaled:center")
std_TMB_Pradat <- attr(scaled_TMB_Pradat, "scaled:scale")
scaled_TMB2_Pradat = (Pradat_info_df$TMB_original ^ lambda_Pradat - mean_TMB_Pradat) / std_TMB_Pradat
temp_TMB = scaled_TMB2_Pradat*std_TMB_MSK + mean_TMB_MSK
temp_TMB <- ifelse(temp_TMB < 0, 0, temp_TMB)
harmonized_TMB_Pradat = (temp_TMB)^(1/lambda_MSK)
Pradat_info_df['TMB_harmonized'] = harmonized_TMB_Pradat
write.csv(Pradat_info_df, paste0(result_dir,"Pradat_TMB_harmonized.csv"))

```

# harmonize NLR for vanguri
```{r}

selected_cols = c('CancerType','NLR')
Chowell1_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Chowell2015-2017")
Chowell1_info_df = Chowell1_info_df[selected_cols]
Chowell2_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Chowell2018")
Chowell2_info_df = Chowell2_info_df[selected_cols]
MSK1_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Morris_new")
MSK1_info_df = MSK1_info_df[selected_cols]
MSK2_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Morris_new2")
MSK2_info_df = MSK2_info_df[selected_cols]
MSK_info_df = rbind(Chowell1_info_df,Chowell2_info_df,MSK1_info_df,MSK2_info_df)
colnames(MSK_info_df)=c('CancerType','NLR')
MSK_NSCLC_info_df = MSK_info_df[MSK_info_df$CancerType=='NSCLC',]

Vanguri_info_df = read_excel(paste0(input_dir,'features_phenotype_allDatasets.xlsx'), "Vanguri_NSCLC_all")
Vanguri_info_df = Vanguri_info_df[selected_cols]

# identify the optimal transformation coefficient for normal transformation (power transformations)
# MSK_NSCLC
# get the normalized NLR for validation of transformation coefficient extraction
transformed_NLR = transformTukey(MSK_NSCLC_info_df$NLR, plotit=FALSE)
scaled_NLR_MSK <- scale(transformed_NLR)
# extract transformation coefficients
lambda_MSK = transformTukey(MSK_NSCLC_info_df$NLR, plotit=TRUE, returnLambda = TRUE)
print(paste('Lambda_MSK_NSCLC: ', lambda_MSK))
mean_NLR_MSK <- attr(scaled_NLR_MSK, "scaled:center")
std_NLR_MSK <- attr(scaled_NLR_MSK, "scaled:scale")


#######  Vanguri_NSCLC 
# extract transformation coefficients
transformed_NLR = transformTukey(Vanguri_info_df$NLR, plotit=FALSE)
scaled_NLR_Vanguri <- scale(transformed_NLR)
lambda_Vanguri = transformTukey(Vanguri_info_df$NLR, plotit=TRUE, returnLambda = TRUE)
print(paste('Lambda_Vanguri: ', lambda_Vanguri))
scaled_NLR_Vanguri <- scale(transformed_NLR)
mean_NLR_Vanguri <- attr(scaled_NLR_Vanguri, "scaled:center")
std_NLR_Vanguri <- attr(scaled_NLR_Vanguri, "scaled:scale")
scaled_NLR2_Vanguri = (-Vanguri_info_df$NLR ^ lambda_Vanguri - mean_NLR_Vanguri) / std_NLR_Vanguri
temp_NLR = scaled_NLR2_Vanguri*std_NLR_MSK + mean_NLR_MSK
temp_NLR <- ifelse(temp_NLR > 0, 0, temp_NLR)
harmonized_NLR_Vanguri = (-temp_NLR)^(1/lambda_MSK)
Vanguri_info_df['NLR_harmonized'] = harmonized_NLR_Vanguri
write.csv(Vanguri_info_df, paste0(result_dir,"Vanguri_NLR_harmonized.csv"))


```

